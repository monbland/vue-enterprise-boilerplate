# Использование локального backend-сервера через Docker

- [Установка Docker](#установка-docker)
- [Установка docker-compose](#установка-docker-compose)
- [Вход в реестр docker-контейнеров](#вход-в-реестр-docker-контейнеров)
- [Настраивание локальных переменных сервера](#настраивание-локальных-переменных-сервера)
- [Запуск сервера](#запуск-сервера)
- [Обновление последней версии сервера](#Обновление-последней-версии-сервера)
- [Создание супер-пользователя на сервере](#Создание-суперпользователя-на-сервере)
- [Использование API для разработки](#Использование-API-для-разработки)

## Установка Docker

Примечание: Данная инструкция проверялась в ОС macOS Catalina 10.15.3

Для работы потребуется следующий софт:

- [Docker](https://docs.docker.com/get-docker/) Версия 17.06 и выше
- [docker-compose](https://docs.docker.com/compose/install/)

## Установка docker compose

```shell script
# Можно установить через pip
pip install docker-compose

# Или через brew
brew install docker-compose
```

## Вход в реестр docker контейнеров

Первый раз, перед запуском сервера необходимо залогиниться в реестре docker-контейнеров, это можно сделать с помощью команды, используя данные входа на корпоративный GitLab Важно: если включена двуфакторная авторизация, то в качестве пароля нужно использовать [Personal Access Token](https://docs.gitlab.com/ee/user/profile/personal_access_tokens.html) с правами доступа `read_registry`

```shell script
docker login gitlab.aetalon.tech:5050
```

## Настраивание локальных переменных сервера

Перед первым запуском необходимо сделать копию .env файла выполнив команду

```shell script
cp env.example .env
```

В файле `.env` можно настроить параметры под себя, но чаще всего это не требуется

## Запуск сервера

Для запуска сервера нужно выполнить команду

```shell script
docker-compose up

# для запуска сервера в фоне можно выполнить команду
docker-compose up -d
```

Если вы сделали всё правильно, то по адресу [http://localhost:8000/index](http://localhost:8000/index) вы увидите главную страницу Django сервера

## Обновление последней версии сервера

Для работы с актуальной версией backend-сервера, перед запуском сервера необходимо выполнить следующую команду

```shell script
docker-compose pull
```

## Создание суперпользователя на сервере

Для полного доступа ко всем возможностям сервера нужно создать пользователя с правами супер-пользователя, для этого выполняем следующую команду

```shell script
docker-compose exec django manage createsuperuser
```

С настройками по-умолчанию для отправки почты будет использован Mailhog, который доступен по адресу [http://localhost:8025](http://localhost:8025)

## Использование API для разработки

Чтобы использовать docker-версию backend, необходимо переопределить переменную среды `API_BASE_URL` сделать это можно с помощью настроек WebStorm или при через командную строку запустив сервер разработки с помощью команды

```shell script
API_BASE_URL=http://localhost:8000 yarn dev
```
